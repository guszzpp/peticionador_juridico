{% extends "layout.html" %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Página Inicial</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ title }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ title }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group mr-2">
            <button type="button" class="btn btn-sm btn-outline-secondary">Buscar</button>
            <button type="button" class="btn btn-sm btn-outline-secondary">Filtrar</button>
        </div>
        <button type="button" class="btn btn-sm btn-success" data-toggle="modal" data-target="#modalCriarModelo">
            + Criar Modelo
        </button>
    </div>
</div>

{# Seção para Modelos de Peças (ex: contrarrazões_re.txt) #}
<h5 class="mt-4">Modelos de Peças Completas</h5>
<div class="table-responsive">
    <table class="table table-striped table-sm">
        <thead>
            <tr>
                <th><input type="checkbox" id="selecionarTodosPecas"></th>
                <th>Nome <i class="fas fa-sort"></i></th>
                <th>Criado/Editado por <i class="fas fa-sort"></i></th>
                <th>Tipo <i class="fas fa-sort"></i></th>
                <th>Data de Criação/Edição <i class="fas fa-sort"></i></th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for modelo in modelos_pecas %}
            <tr>
                <td><input type="checkbox" class="selecionarItemPeca" data-id="{{ modelo.nome }}"></td>
                <td><i class="far fa-file-alt mr-2"></i>{{ modelo.nome }}</td>
                <td>{{ modelo.criado_por }}</td>
                <td>{{ modelo.tipo_movimento }}</td>
                <td>{{ modelo.data_criacao }}</td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary" title="Visualizar"><i class="fas fa-eye"></i></button>
                    <button class="btn btn-sm btn-outline-primary" title="Editar"><i class="fas fa-edit"></i></button>
                    {# Para modelos base do sistema, o delete pode ser desabilitado #}
                    {# <button class="btn btn-sm btn-outline-danger" title="Excluir"><i class="fas fa-trash-alt"></i></button> #}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" class="text-center">Nenhum modelo de peça encontrado.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{# Seção para Modelos de Teses/Argumentos (textos menores) #}
<h5 class="mt-5">Modelos de Teses/Argumentos Avulsos</h5>
<div class="table-responsive">
    <table class="table table-striped table-sm">
        <thead>
            <tr>
                <th><input type="checkbox" id="selecionarTodosTeses"></th>
                <th>Conteúdo da Tese/Argumento <i class="fas fa-sort"></i></th>
                <th>Tipo <i class="fas fa-sort"></i></th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for tese in modelos_teses %}
            <tr>
                <td><input type="checkbox" class="selecionarItemTese" data-id="{{ tese.nome }}"></td>
                <td><i class="far fa-comment-dots mr-2"></i>{{ tese.nome }}</td>
                <td>{{ tese.tipo_movimento }}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" title="Editar"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger" title="Excluir"><i class="fas fa-trash-alt"></i></button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="4" class="text-center">Nenhuma tese/argumento avulso encontrado.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="modalCriarModelo" tabindex="-1" role="dialog" aria-labelledby="modalCriarModeloLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCriarModeloLabel">Criar/Editar Modelo</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formModelo">
                    <input type="hidden" id="modeloId">
                    <div class="form-group">
                        <label for="modeloNome">Nome do Modelo/Tese:</label>
                        <input type="text" class="form-control" id="modeloNome" required>
                    </div>
                    <div class="form-group">
                        <label for="modeloTipo">Tipo:</label>
                        <select class="form-control" id="modeloTipo">
                            <option value="peca">Modelo de Peça (.docx, .odt, .txt)</option>
                            <option value="tese">Tese/Argumento (Texto)</option>
                        </select>
                    </div>
                    <div class="form-group" id="grupoUploadArquivo">
                        <label for="modeloArquivo">Carregar Arquivo (.docx, .odt, .txt):</label>
                        <input type="file" class="form-control-file" id="modeloArquivo" accept=".docx,.odt,.txt">
                        <small class="form-text text-muted">Apenas para "Modelo de Peça". O conteúdo será extraído como texto.</small>
                    </div>
                    <div class="form-group" id="grupoConteudoTexto">
                        <label for="modeloConteudo">Conteúdo do Texto (para Teses ou edição de Peças):</label>
                        <textarea class="form-control" id="modeloConteudo" rows="10"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnSalvarModelo">Salvar Modelo</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
$(document).ready(function() {
    // Lógica para mostrar/esconder upload de arquivo vs. textarea baseado no tipo de modelo
    $('#modeloTipo').on('change', function() {
        if ($(this).val() === 'peca') {
            $('#grupoUploadArquivo').show();
            $('#grupoConteudoTexto').find('label').text('Conteúdo do Texto (Pré-visualização/Edição):');
            // No futuro, ao carregar .docx/.odt, você converteria para texto e popularia #modeloConteudo
        } else { // 'tese'
            $('#grupoUploadArquivo').show();
            $('#grupoConteudoTexto').find('label').text('Conteúdo da Tese/Argumento:');
        }
    }).trigger('change'); // Dispara na carga para estado inicial

    // Placeholder para salvar o modelo
    $('#btnSalvarModelo').on('click', function() {
        const nome = $('#modeloNome').val();
        const tipo = $('#modeloTipo').val();
        const conteudo = $('#modeloConteudo').val();
        const arquivoInput = $('#modeloArquivo')[0];

        if (!nome) {
            alert("Por favor, informe o nome do modelo/tese.");
            return;
        }

        if (tipo === 'peca' && arquivoInput.files.length > 0) {
            const arquivo = arquivoInput.files[0];
            const nomeArquivo = arquivo.name.toLowerCase();
            if (!nomeArquivo.endsWith('.docx') && !nomeArquivo.endsWith('.odt') && !nomeArquivo.endsWith('.txt')) {
                alert("Tipo de arquivo inválido para modelo de peça. Use .docx, .odt ou .txt.");
                return;
            }
            // Aqui você enviaria o arquivo para o backend para salvar e extrair o texto
            alert(`Simulando upload do arquivo: <span class="math-inline">\{arquivo\.name\} para o modelo de peça "</span>{nome}". O conteúdo seria extraído e salvo.`);
        } else if (tipo === 'tese' && !conteudo) {
             alert("Por favor, insira o conteúdo da tese/argumento.");
             return;
        } else if (tipo === 'peca' && !conteudo && !$('#modeloId').val()){ // Novo modelo de peça sem arquivo e sem texto
            alert("Para um novo modelo de peça, forneça um arquivo ou o conteúdo em texto.");
            return;
        }


        // Lógica de AJAX para enviar para o backend e salvar
        // Por agora, apenas um alerta e fecha o modal
        console.log("Salvando modelo:", { nome, tipo, conteudo, arquivo: arquivoInput.files.length > 0 ? arquivoInput.files[0].name : null });
        alert(`Modelo/Tese "${nome}" salvo (simulado)!`);
        $('#modalCriarModelo').modal('hide');
        // Idealmente, recarregaria a lista de modelos na página via AJAX ou reload.
        location.reload(); 
    });

    // Adicionar FontAwesome se ainda não tiver no layout.html para os ícones
    // <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
});
</script>
{% endblock %}