{% extends "layout.html" %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Página inicial</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ title }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ title }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group mr-2">
            <button type="button" class="btn btn-sm btn-outline-secondary">Buscar</button>
            <button type="button" class="btn btn-sm btn-outline-secondary">Filtrar</button>
        </div>
        <button type="button" class="btn btn-sm btn-success" data-toggle="modal" data-target="#modalCriarModelo">
            + Criar modelo
        </button>
    </div>
</div>

{# Seção para Modelos de Peças Completas #}
<h5 class="mt-4">Modelos de peças completas</h5>
<div class="table-responsive">
    <table class="table table-striped table-sm">
        <thead>
            <tr>
                <th class="coluna-checkbox">
                    <input type="checkbox" id="selecionarTodosPecas">
                </th>
                <th class="coluna-nome-peca">Nome <i class="fas fa-sort"></i></th>
                <th class="coluna-data">Data de criação/edição <i class="fas fa-sort"></i></th>
                <th class="coluna-acoes">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for modelo in modelos_pecas %}
            <tr>
                <td class="coluna-checkbox">
                    <input type="checkbox" class="selecionarItemPeca" data-id="{{ modelo.id | default(modelo.nome) }}">
                </td>
                <td class="coluna-nome-peca">
                    <i class="far fa-file-alt mr-2"></i>{{ modelo.nome }}
                </td>
                <td class="coluna-data">{{ modelo.data_modificacao }}</td>
                <td class="coluna-acoes">                    
                    <button class="btn btn-sm btn-outline-primary btn-editar-modelo" title="Editar" data-id="{{ modelo.id | default(modelo.nome) }}" data-nome="{{ modelo.nome }}" data-tipo="peca"><i class="fas fa-edit"></i></button>
                    {% if modelo.deletavel %}
                    <button class="btn btn-sm btn-outline-danger btn-excluir-modelo" title="Excluir" data-id="{{ modelo.id | default(modelo.nome) }}" data-tipo="peca"><i class="fas fa-trash-alt"></i></button>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="4" class="text-center">Nenhum modelo de peça encontrado.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{# Seção para Modelos de teses #}
<h5 class="mt-5">Modelos de teses</h5>
<div class="table-responsive">
    <table class="table table-striped table-sm">
        <thead>
            <tr>
                <th class="coluna-checkbox">
                    <input type="checkbox" id="selecionarTodosTeses">
                </th>
                <th class="coluna-conteudo-tese">Conteúdo da tese <i class="fas fa-sort"></i></th>
                <th class="coluna-data">Data de criação/edição <i class="fas fa-sort"></i></th>
                <th class="coluna-acoes">Ações</th> {# CLASSE ADICIONADA #}                    
            </tr>
        </thead>
        <tbody>
            {% for tese in modelos_teses %}
            <tr>
                <td class="coluna-checkbox">
                    <input type="checkbox" class="selecionarItemTese" data-id="{{ tese.id | default(tese.nome) }}">
                </td>
                <td class="coluna-conteudo-tese"> {# Ícone já está no HTML anterior #}
                    {{ tese.nome }}
                </td> 
                <td class="coluna-data">{{ tese.data_modificacao }}</td>
                <td class="coluna-acoes"> {# CLASSE ADICIONADA #}
                    {% if tese.editavel %}
                    <button class="btn btn-sm btn-outline-primary btn-editar-tese" title="Editar" data-id="{{ tese.id | default(tese.nome) }}" data-nome="{{ tese.nome_arquivo | default(tese.nome) }}" data-conteudo="{{ tese.conteudo_completo | default(tese.nome) }}" data-tipo="tese" data-eh-predefinida="{{ 'true' if tese.eh_predefinida else 'false' }}"><i class="fas fa-edit"></i></button>
                    {% endif %}
                    {% if tese.deletavel %}
                    <button class="btn btn-sm btn-outline-danger btn-excluir-tese" title="Excluir" data-id="{{ tese.id | default(tese.nome) }}" data-tipo="tese"><i class="fas fa-trash-alt"></i></button>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="4" class="text-center">Nenhuma tese encontrada.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{# Modal para Criar/Editar Modelo/Tese #}
<div class="modal fade" id="modalCriarModelo" tabindex="-1" role="dialog" aria-labelledby="modalCriarModeloLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCriarModeloLabel">Criar/editar modelo ou tese</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formModelo">
                    {# Campo para armazenar o ID do modelo/tese em caso de edição #}
                    <input type="hidden" id="modeloId" name="modelo_id">
                    {# Campo para armazenar o nome original do arquivo/tese em caso de edição, para o backend identificar #}
                    <input type="hidden" id="modeloNomeOriginal" name="modelo_nome_original">
                    <input type="hidden" id="modeloEhPredefinida" name="modelo_eh_predefinida">


                    <div class="form-group">
                        <label for="modeloNome">Nome do modelo/tese:</label>
                        <input type="text" class="form-control" id="modeloNome" name="nome" required>
                        <small id="nomeModeloHelp" class="form-text text-muted">Para peças, este será o nome do arquivo (ex: minha_peca.txt). Para teses, um nome descritivo.</small>
                    </div>
                    <div class="form-group">
                        <label for="modeloTipo">Tipo:</label>
                        <select class="form-control" id="modeloTipo" name="tipo">
                            <option value="peca">Modelo de peça (baseado em arquivo .txt)</option>
                            <option value="tese">Tese (texto puro)</option>
                        </select>
                    </div>
                    <div class="form-group" id="grupoUploadArquivo">
                        <label for="modeloArquivo">Substituir/carregar arquivo (.txt):</label>
                        <input type="file" class="form-control-file" id="modeloArquivo" name="arquivo" accept=".txt">
                        <small class="form-text text-muted">Apenas para "modelo de peça". O conteúdo do arquivo .txt substituirá o texto abaixo se um arquivo for enviado.</small>
                    </div>
                    <div class="form-group" id="grupoConteudoTexto">
                        <label for="modeloConteudo">Conteúdo do texto:</label>
                        <textarea class="form-control" id="modeloConteudo" name="conteudo" rows="10" placeholder="Digite ou cole o conteúdo aqui..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnSalvarModelo">Salvar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
$(document).ready(function() {
    function ajustarModalParaTipo(ehEdicaoDePredefinida = false) {
        const tipoSelecionado = $('#modeloTipo').val();
        if (tipoSelecionado === 'peca') {
            $('#grupoUploadArquivo').show();
            $('#grupoUploadArquivo label').text('Substituir/carregar arquivo .txt (opcional):');
            $('#modeloConteudo').attr('placeholder', 'O conteúdo do arquivo .txt aparecerá aqui para edição, ou cole o texto diretamente.');
            $('#nomeModeloHelp').text('Este será o nome do arquivo (ex: minha_peca.txt). O arquivo será salvo como .txt.');
            $('#modeloNome').prop('readonly', false);
            $('#modeloConteudo').prop('readonly', false);
            $('#btnSalvarModelo').show();
        } else { // 'tese'
            $('#grupoUploadArquivo').hide();
            $('#grupoConteudoTexto').find('label').text('Conteúdo da tese:');
            $('#modeloConteudo').attr('placeholder', 'Digite o conteúdo da tese aqui.');
            $('#nomeModeloHelp').text('Este é um nome descritivo para a tese. A tese será salva como um arquivo .txt com este nome (sem a extensão .txt).');
            if (ehEdicaoDePredefinida) {
                $('#modeloNome').prop('readonly', true);
                $('#modeloConteudo').prop('readonly', true);
                $('#btnSalvarModelo').hide();
                 $('#nomeModeloHelp').text('Visualizando tese predefinida. Para usar, copie o conteúdo.');
            } else {
                $('#modeloNome').prop('readonly', false);
                $('#modeloConteudo').prop('readonly', false);
                $('#btnSalvarModelo').show();
            }
        }
    }

    $('#modeloTipo').on('change', function() {
        ajustarModalParaTipo($('#modeloEhPredefinida').val() === 'true');
    });

    // Limpar e configurar modal ao abrir para CRIAR NOVO
    $('#modalCriarModelo').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget); 
        var isTriggeredByEditButton = button.hasClass('btn-editar-modelo') || button.hasClass('btn-editar-tese');

        if (!isTriggeredByEditButton) { // Só limpa e reconfigura se for o botão "+ Criar modelo"
            var modal = $(this);
            modal.find('form')[0].reset(); 
            $('#modeloId').val(''); 
            $('#modeloNomeOriginal').val('');
            $('#modeloEhPredefinida').val('false');
            modal.find('.modal-title').text('Criar novo modelo ou tese');
            $('#modeloTipo').val('peca').prop('disabled', false); // Habilita e Padrão para peça
            $('#modeloNome').prop('readonly', false);
            $('#modeloConteudo').prop('readonly', false);
            $('#btnSalvarModelo').show();
            ajustarModalParaTipo(false); 
        }
    });
    
    // Re-habilita campos e botão ao fechar modal
    $('#modalCriarModelo').on('hidden.bs.modal', function () {
        $('#modeloTipo').prop('disabled', false);
        $('#modeloNome').prop('readonly', false);
        $('#modeloConteudo').prop('readonly', false);
        $('#btnSalvarModelo').show();
        $(this).find('form')[0].reset();
    });

    // Configurar modal para EDITAR PEÇA
    $(document).on('click', '.btn-editar-modelo', function() {
        const modeloId = $(this).data('id'); 
        const nomeModelo = $(this).data('nome'); 

        $('#modalCriarModeloLabel').text('Editar modelo de peça');
        $('#modeloId').val(modeloId); 
        $('#modeloNomeOriginal').val(nomeModelo); 
        $('#modeloNome').val(nomeModelo.replace('.txt', '')); 
        $('#modeloTipo').val('peca').prop('disabled', true); 
        $('#modeloEhPredefinida').val('false');

        ajustarModalParaTipo(false); // Garante que os campos estejam editáveis

        $.get("{{ url_for('obter_conteudo_modelo_endpoint') }}", { nome_arquivo: nomeModelo, tipo: 'peca' })
            .done(function(data) {
                $('#modeloConteudo').val(data.conteudo);
            })
            .fail(function() {
                $('#modeloConteudo').val('');
                alert('Erro ao carregar o conteúdo do modelo de peça.');
            });
        $('#modalCriarModelo').modal('show');
    });

    // Configurar modal para EDITAR/VISUALIZAR TESE
    $(document).on('click', '.btn-editar-tese', function() {
        const teseId = $(this).data('id'); 
        const nomeOriginal = $(this).data('nome'); 
        let conteudoTese = $(this).data('conteudo'); // Conteúdo já vem via data-attribute para predefinidas
        const ehPredefinida = $(this).data('eh-predefinida').toString() === 'true';

        $('#modeloId').val(teseId);
        $('#modeloNomeOriginal').val(nomeOriginal); // Se for predefinida, é o ID; se não, é o nome do arquivo
        $('#modeloNome').val(ehPredefinida ? nomeOriginal : nomeOriginal.replace('.txt', ''));
        $('#modeloTipo').val('tese').prop('disabled', true);
        $('#modeloEhPredefinida').val(ehPredefinida.toString());
        
        $('#modalCriarModeloLabel').text(ehPredefinida ? 'Visualizar tese predefinida' : 'Editar tese');

        if (ehPredefinida) {
            $('#modeloConteudo').val(conteudoTese); // Usa o conteúdo do data-attribute
            ajustarModalParaTipo(true); // Configura para visualização
        } else {
            // Para teses de usuário, busca o conteúdo completo via AJAX
            ajustarModalParaTipo(false); // Configura para edição
            $.get("{{ url_for('obter_conteudo_modelo_endpoint') }}", { nome_arquivo: nomeOriginal, tipo: 'tese' })
                .done(function(data) {
                    $('#modeloConteudo').val(data.conteudo);
                })
                .fail(function() {
                    $('#modeloConteudo').val('');
                    alert('Erro ao carregar o conteúdo da tese.');
                });
        }
        $('#modalCriarModelo').modal('show');
    });

    // Salvar o modelo/tese
    $('#btnSalvarModelo').on('click', function() {
        const form = $('#formModelo')[0];
        const formData = new FormData(form);
        const nomeModeloForm = $('#modeloNome').val().trim();
        const tipoModelo = $('#modeloTipo').val(); // Tipo sempre estará disponível

        if (!nomeModeloForm) {
            alert("Por favor, informe o nome do modelo/tese.");
            return;
        }
        // Se for tese e o conteúdo estiver vazio E não for uma edição (modeloId não preenchido para nova tese)
        if (tipoModelo === 'tese' && !$('#modeloConteudo').val().trim() && !$('#modeloId').val()) {
             alert("Por favor, insira o conteúdo da tese.");
             return;
        }
        if (tipoModelo === 'peca' && !$('#modeloConteudo').val().trim() && $('#modeloArquivo')[0].files.length === 0 && !$('#modeloId').val()) {
            alert("Para uma nova peça, forneça um arquivo .txt ou cole o conteúdo.");
            return;
        }

        // Garante que o tipo (que pode estar disabled no form) seja incluído
        if ($('#modeloTipo').is(':disabled')) {
            formData.set('tipo', tipoModelo);
        }
        // Garante que o nome (que pode estar disabled no form para tese predef) seja incluído,
        // mas a lógica do backend já impede salvar tese predefinida.
        if ($('#modeloNome').is(':disabled')) {
             formData.set('nome', nomeModeloForm);
        }


        $.ajax({
            url: "{{ url_for('salvar_modelo_endpoint') }}",
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                alert(response.mensagem || 'Operação realizada com sucesso!');
                $('#modalCriarModelo').modal('hide');
                location.reload(); 
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.erro : 'Erro ao realizar a operação.';
                alert(errorMsg);
            }
        });
    });

    // EXCLUIR MODELO DE PEÇA
    $(document).on('click', '.btn-excluir-modelo', function() {
        const nomeArquivo = $(this).data('id');
        if (confirm(`Tem certeza que deseja excluir o modelo de peça "${nomeArquivo}"? Esta ação não pode ser desfeita.`)) {
            $.ajax({
                url: "{{ url_for('excluir_modelo_endpoint') }}",
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ nome_arquivo: nomeArquivo, tipo: 'peca' }),
                success: function(response) {
                    alert(response.mensagem);
                    location.reload();
                },
                error: function(xhr) {
                    alert(xhr.responseJSON ? xhr.responseJSON.erro : 'Erro ao excluir modelo.');
                }
            });
        }
    });

    // EXCLUIR TESE SALVA
    $(document).on('click', '.btn-excluir-tese', function() {
        const nomeArquivoTeseOuIdPredef = $(this).data('id'); 
        // Verificamos se é predefinida pelo atributo que o backend envia
        const ehPredefinida = $(this).closest('tr').find('.btn-editar-tese').data('eh-predefinida'); 

        if (ehPredefinida === true || ehPredefinida === 'true') { // Checagem mais robusta
            alert("Teses predefinidas não podem ser excluídas.");
            return;
        }

        // Se não for predefinida, nomeArquivoTeseOuIdPredef é o nome do arquivo
        if (confirm(`Tem certeza que deseja excluir a tese "${nomeArquivoTeseOuIdPredef}"? Esta ação não pode ser desfeita.`)) {
             $.ajax({
                url: "{{ url_for('excluir_modelo_endpoint') }}", 
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ nome_arquivo: nomeArquivoTeseOuIdPredef, tipo: 'tese' }),
                success: function(response) {
                    alert(response.mensagem);
                    location.reload();
                },
                error: function(xhr) {
                    alert(xhr.responseJSON ? xhr.responseJSON.erro : 'Erro ao excluir tese.');
                }
            });
        }
    });

});
</script>
{% endblock %}